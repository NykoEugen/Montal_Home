{% extends 'shop/base.html' %}
{% load cart_filters %}
{% load static %}
{% load responsive_images %}
{% block structured_data %}
  {{ block.super }}
  {% if product_schema %}
  <script type="application/ld+json">{{ product_schema|safe }}</script>
  {% endif %}
{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- Left: Gallery with vertical thumbs -->
    <div class="lg:col-span-7 flex flex-col items-center gap-4 max-w-[720px] w-full mx-auto">
      <div class="w-full bg-white rounded-lg shadow p-4">
        <div class="relative">
          <div id="alt-main-image-wrapper"
               class="w-full bg-beige-100 rounded flex items-center justify-center overflow-hidden"
               style="aspect-ratio: 1 / 1;">
            {% with first_image=gallery_images.0.image %}
            <img id="alt-main-image"
                 {% if first_image %}
                 src="{{ first_image|image_variant }}"
                 srcset="{% responsive_srcset first_image %}"
                 sizes="{% responsive_sizes '(max-width: 1024px) 100vw, 600px' %}"
                 data-srcset="{% responsive_srcset first_image %}"
                 data-sizes="{% responsive_sizes '(max-width: 1024px) 100vw, 600px' %}"
                 data-width="{{ first_image.width }}"
                 data-height="{{ first_image.height }}"
                 {% endif %}
                 alt="{{ furniture.name }}"
                 class="w-full h-full object-contain"
                 data-current-index="0"
                 data-gallery-size="{% if gallery_images %}{{ gallery_images|length }}{% else %}0{% endif %}">
            {% endwith %}
          </div>
          {% if gallery_images and gallery_images|length > 1 %}
          <button type="button"
                  class="gallery-nav gallery-nav-prev absolute left-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-9 h-9 flex items-center justify-center shadow"
                  aria-label="Попереднє зображення">
            &#10094;
          </button>
          <button type="button"
                  class="gallery-nav gallery-nav-next absolute right-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-9 h-9 flex items-center justify-center shadow"
                  aria-label="Наступне зображення">
            &#10095;
          </button>
          <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2">
            {% for img in gallery_images %}
            <span class="gallery-dot {% if forloop.first %}bg-brown-800{% else %}bg-white/80{% endif %} w-2.5 h-2.5 rounded-full border border-brown-500/40" data-index="{{ forloop.counter0 }}"></span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      {% if gallery_images %}
      <div class="w-full">
        <div class="relative">
          {% if gallery_images|length > 4 %}
          <button type="button"
                  class="thumb-nav thumb-nav-prev absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-8 h-8 flex items-center justify-center shadow"
                  aria-label="Прокрутити вліво">
            &#10094;
          </button>
          <button type="button"
                  class="thumb-nav thumb-nav-next absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-8 h-8 flex items-center justify-center shadow"
                  aria-label="Прокрутити вправо">
            &#10095;
          </button>
          {% endif %}
          <div class="overflow-hidden px-10" data-thumb-scroller>
            <div class="flex gap-3" data-thumb-track>
              {% for img in gallery_images %}
              <img src="{{ img.image|image_variant:400 }}"
                   srcset="{% responsive_srcset img.image %}"
                   sizes="{% responsive_sizes '(max-width: 1024px) 180px, 220px' %}"
                   alt="{{ img.alt_text|default:furniture.name }}"
                   class="w-24 h-24 md:w-28 md:h-28 object-cover rounded border cursor-pointer thumb-item {% if forloop.first %}ring-2 ring-brown-800{% endif %}"
                   data-full="{{ img.image|image_variant:1200 }}"
                   data-srcset="{% responsive_srcset img.image %}"
                   data-sizes="{% responsive_sizes '(max-width: 1024px) 100vw, 600px' %}"
                   data-index="{{ forloop.counter0 }}"
                   data-width="{{ img.image.width }}"
                   data-height="{{ img.image.height }}">
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right: Sticky buy card -->
    <div class="lg:col-span-5">
      <div id="buy-card" class="lg:sticky lg:top-6 bg-white rounded-lg shadow p-6" data-base-size-id="{{ base_size_variant_id|default:'' }}">
        <h1 class="text-2xl font-bold text-brown-800">{{ furniture.name }}</h1>
        <p class="text-sm text-brown-600 mt-1">{{ furniture.sub_category.name }} • Код: {{ furniture.article_code }}</p>
        <div class="mt-3">
          <span id="alt-stock-label"
                class="px-3 py-1 rounded-full text-xs {% if initial_stock_status == 'in_stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}"
                data-base-status="{{ furniture.stock_status }}"
                data-base-text="{{ furniture.get_stock_status_display }}"
                data-default-status="{{ initial_stock_status }}"
                data-default-text="{{ initial_stock_label }}">
            {{ initial_stock_label }}
          </span>
        </div>

        <div class="mt-4 flex items-end gap-3">
          {% if furniture.is_promotional and furniture.promotional_price %}
            <p class="text-3xl text-red-600 font-semibold" id="alt-main-price">{{ furniture.promotional_price|floatformat:0 }} грн</p>
            <p class="text-lg text-brown-500 line-through" id="alt-original-price">{{ furniture.price|floatformat:0 }} грн</p>
          {% else %}
            <p class="text-3xl text-brown-800 font-semibold" id="alt-main-price">{{ furniture.price|floatformat:0 }} грн</p>
            <p class="text-lg text-brown-500 line-through" id="alt-original-price" style="display: none;">{{ furniture.price|floatformat:0 }} грн</p>
          {% endif %}
        </div>

        {% if custom_option_name and custom_options %}
        <div class="mt-5">
          <p class="text-sm font-semibold text-brown-700 mb-2">{{ custom_option_name }}</p>
          <div class="flex flex-wrap gap-2" data-custom-option-group>
            {% for option in custom_options %}
            <button type="button"
                    class="chip custom-option-chip"
                    data-option-id="{{ option.id }}"
                    data-option-value="{{ option.value }}"
                    data-option-price="{{ option.price_delta|default_if_none:0 }}">
              {{ option.value }}
              {% if option.price_delta %}
              <span class="text-xs text-brown-600">(+{{ option.price_delta|floatformat:0 }} грн)</span>
              {% endif %}
            </button>
            {% endfor %}
          </div>
          <p class="text-sm text-red-600 mt-2 hidden" data-custom-option-warning>Оберіть варіант перед додаванням у кошик.</p>
        </div>
        {% endif %}

        {% if variant_images %}
        <div class="mt-4">
          <label class="block text-brown-700 font-medium mb-2">Варіанти</label>
          <div class="flex flex-wrap gap-2">
            {% for variant in variant_images %}
            <button type="button" class="chip variant-chip{% if variant.is_default %} chip--active{% endif %}" 
                    data-id="{{ variant.id }}" 
                    data-image="{{ variant.image|image_variant:1200 }}"
                    data-srcset="{% responsive_srcset variant.image %}"
                    data-sizes="{% responsive_sizes '(max-width: 1024px) 100vw, 600px' %}"
                    data-name="{{ variant.name }}"
                    data-stock-status="{{ variant.stock_status }}"
                    data-stock-label="{{ variant.get_stock_status_display }}"
                    data-image-width="{{ variant.image.width }}"
                    data-image-height="{{ variant.image.height }}"
                    {% if variant.link %}data-link="{{ variant.link }}"{% endif %}>
              <img src="{{ variant.image|image_variant:400 }}"
                   srcset="{% responsive_srcset variant.image %}"
                   sizes="{% responsive_sizes '(max-width: 768px) 32px, 48px' %}"
                   alt="{{ variant.name }}"
                   class="w-6 h-6 object-cover rounded">
              <span>{{ variant.name }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if size_variants %}
        <div class="mt-4">
          <label for="alt-size" class="block text-brown-700 font-medium mb-2">Розмір (ДхШхВ)</label>
          <div class="grid grid-cols-2 gap-2">
            {% if base_dimensions and not base_size_variant_id %}
            <button type="button" class="chip size-chip" 
                    data-id="base" 
                    data-price="{% if furniture.is_sale_active %}{{ furniture.promotional_price }}{% else %}{{ furniture.price }}{% endif %}" 
                    data-original-price="{{ furniture.price }}"
                    data-dimensions="{{ base_dimensions }}"
                    data-is-on-sale="{{ furniture.is_sale_active|yesno:'true,false' }}">
                {{ base_dimensions }}
            </button>
            {% endif %}
            {% for variant in size_variants %}
            <button type="button" class="chip size-chip" 
                    data-id="{{ variant.id }}" 
                    data-price="{% if variant.is_sale_active %}{{ variant.current_price }}{% else %}{{ variant.price }}{% endif %}" 
                    data-original-price="{{ variant.price }}"
                    data-dimensions="{{ variant.dimensions }}"
                    data-is-on-sale="{{ variant.is_sale_active|yesno:'true,false' }}"
                    {% if variant.parameter %}
                    data-param-key="{{ variant.parameter.key }}"
                    data-param-value="{{ variant.parameter_value }}"
                    {% endif %}>
                {{ variant.dimensions }}
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if fabric_categories %}
        <div class="mt-4" data-fabric-value="{{ furniture.fabric_value|default:1.0 }}">
          <label class="block text-brown-700 font-medium mb-2" for="alt-fabric">Категорія тканини</label>
          <select id="alt-fabric" class="w-full p-3 border border-brown-300 rounded-lg">
            <option value="">Cтандарт</option>
            {% for category in fabric_categories %}
            <option value="{{ category.id }}" data-price="{{ category.price }}" data-calculated-price="{{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }}">{{ category.name }} — {{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }} грн</option>
            {% endfor %}
          </select>
          <p id="alt-fabric-extra" class="mt-2 text-sm text-brown-700 hidden">Додаткова вартість: <span id="alt-fabric-price" class="font-semibold"></span> грн</p>
        </div>
        {% endif %}

        {% if color_palettes %}
        <div class="mt-6" data-color-selector>
          <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
            <h3 class="text-xl font-semibold text-brown-800">Палітра кольорів</h3>
            <p class="text-sm text-brown-600 font-medium">
              <span data-selected-color-label>Колір не обрано</span>
            </p>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-2" data-color-grid>
            {% for palette in color_palettes %}
              {% with colors=palette.colors.all %}
                {% if colors %}
                  {% for color in colors %}
                  <button type="button"
                          class="color-swatch group flex flex-col items-center gap-1 rounded-lg border border-transparent p-2 text-center transition-all duration-200 hover:border-brown-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brown-500"
                          data-color-swatch
                          data-color-id="{{ color.id }}"
                          data-color-name="{{ color.name }}"
                          {% if palette.name %}data-palette-name="{{ palette.name }}"{% endif %}
                          {% if color.hex_code %}data-color-hex="{{ color.hex_code }}"{% endif %}
                          {% if color.image %}data-color-image="{{ color.image.url }}"{% endif %}
                          aria-pressed="false">
                    {% if color.hex_code %}
                    <span class="w-12 h-12 rounded-full border border-brown-100 shadow-sm transform transition-transform duration-200 group-hover:scale-110" style="background-color: {{ color.hex_code }};"></span>
                    {% elif color.image %}
                    <img src="{{ color.image|image_variant:200 }}"
                         srcset="{% responsive_srcset color.image %}"
                         sizes="{% responsive_sizes '(max-width: 768px) 48px, 64px' %}"
                         alt="{{ color.name }}"
                         class="w-12 h-12 rounded-full object-cover border border-brown-100 shadow-sm transform transition-transform duration-200 group-hover:scale-110"
                         loading="lazy">
                    {% else %}
                    <span class="w-12 h-12 rounded-full border border-dashed border-brown-200 flex items-center justify-center text-xs text-brown-400">N/A</span>
                    {% endif %}
                    <span class="text-xs text-brown-700 leading-tight">{{ color.name }}</span>
                  </button>
                  {% endfor %}
                {% endif %}
              {% endwith %}
            {% endfor %}
          </div>
          <p class="text-xs text-brown-500 mt-2">Оберіть колір, щоб зафіксувати його у замовленні.</p>
        </div>
        {% endif %}

        <div class="mt-4 flex items-center gap-3">
          <label for="alt-qty" class="text-brown-700">Кількість</label>
          <input id="alt-qty" type="number" min="1" value="1" class="w-24 p-2 border border-brown-300 rounded">
        </div>


        <form class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3" method="post" action="{% url 'shop:add_to_cart_from_detail' %}">
          {% csrf_token %}
          <input type="hidden" name="furniture_id" value="{{ furniture.id }}">
          <input type="hidden" name="furniture_slug" value="{{ furniture.slug }}">
          <input type="hidden" name="size_variant_id" id="alt-size-input">
          <input type="hidden" name="fabric_category_id" id="alt-fabric-input">
          <input type="hidden" name="variant_image_id" id="alt-variant-input">
          <input type="hidden" name="quantity" id="alt-qty-input" value="1">
          <input type="hidden" name="custom_option_id" id="alt-custom-option-input">
          <input type="hidden" name="color_id" id="alt-color-input">
          <button type="submit" class="btn-grad px-5 py-2 text-base font-semibold rounded place-self-start max-w-fit">Додати в кошик</button>
        </form>
      </div>
    </div>
  </div>

  <section class="mt-10 scroll-stack" data-scroll-stack>
    <div class="scroll-stack__grid">
      <div>
        <p class="scroll-stack__eyebrow">Більше про {{ furniture.name }}</p>
        <h2 class="scroll-stack__title">Все важливе перед замовленням</h2>
        <p class="scroll-stack__subtitle">
          Тут є історія моделі, точні параметри та сервісні умови, щоб ви могли швидко зрозуміти, чи впишеться {{ furniture.sub_category.name|lower }} у ваш простір.
        </p>
      </div>
      <div class="scroll-stack__tabs" role="tablist">
        <button type="button" class="scroll-tab is-active" id="tab-desc" data-scroll-tab="desc" aria-controls="stack-desc" role="tab" aria-selected="true">
          <span class="scroll-tab__label">Опис</span>
          <span class="scroll-tab__hint">Матеріали, настрій, сценарії використання</span>
        </button>
        <button type="button" class="scroll-tab" id="tab-specs" data-scroll-tab="specs" aria-controls="stack-specs" role="tab" aria-selected="false">
          <span class="scroll-tab__label">Характеристики</span>
          <span class="scroll-tab__hint">Розміри, наповнення, додаткові опції</span>
        </button>
        <button type="button" class="scroll-tab" id="tab-shipping" data-scroll-tab="shipping" aria-controls="stack-shipping" role="tab" aria-selected="false">
          <span class="scroll-tab__label">Доставка та оплата</span>
          <span class="scroll-tab__hint">Терміни виготовлення, варіанти оплати, сервіс</span>
        </button>
      </div>
    </div>

    <div class="scroll-stack__body">
      <article id="stack-desc" class="scroll-card is-active" data-scroll-card="desc" role="tabpanel" aria-labelledby="tab-desc">
        <div class="scroll-card__badge">01</div>
        <div class="scroll-card__content">
          <h3 class="scroll-card__title">Опис</h3>
          <p class="scroll-card__lead">
            {{ furniture.sub_category.name }} створена, щоб доповнити ваш простір, працювати і як акцент, і як спокійний фон.
          </p>
          <div class="scroll-card__rich-text">
            {{ furniture.description|default:'Уточнюйте детальний опис у консультанта Montal Home.' }}
          </div>
        </div>
      </article>

      <article id="stack-specs" class="scroll-card" data-scroll-card="specs" role="tabpanel" aria-labelledby="tab-specs">
        <div class="scroll-card__badge">02</div>
        <div class="scroll-card__content">
          <h3 class="scroll-card__title">Ключові характеристики</h3>
          <p class="scroll-card__lead">Ми зібрали основні параметри, що важливі перед замовленням.</p>
          {% if parameters %}
          <div class="scroll-card__table-wrapper">
            <table class="scroll-card__table">
              <tbody>
              {% for param in parameters %}
                <tr class="{% if param.key == 'dimensions' %}alt-dim-row{% endif %}">
                  <th scope="row">{{ param.label }}</th>
                  <td
                      {% if param.key == 'dimensions' %}id="alt-dimensions"{% else %}id="alt-param-{{ param.key }}"{% endif %}
                      data-param-key="{{ param.key }}"
                      data-base="{{ param.base_value|default:param.value }}">{{ param.value }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-brown-700">Характеристики уточнюються індивідуально під час консультації.</p>
          {% endif %}
        </div>
      </article>

      <article id="stack-shipping" class="scroll-card" data-scroll-card="shipping" role="tabpanel" aria-labelledby="tab-shipping">
        <div class="scroll-card__badge">03</div>
        <div class="scroll-card__content">
          <h3 class="scroll-card__title">Доставка, оплата та сервіс</h3>
          <p class="scroll-card__lead">Щоб ви розуміли, як швидко отримаєте виріб та який сервіс ми можемо запропонувати.</p>
          <ul class="scroll-card__list">
            <li>
              <span class="scroll-card__pill">Доставка</span>
              <p>Доставка по Україні перевізником Нова Пошта, можлива доставка по місту Дніпро. Також можете отримати замовлення в магазині</p>
            </li>
            <li>
              <span class="scroll-card__pill">Оплата</span>
              <p>Оплата здійснюється на рахунок ФОП. Для виробів під замовлення — 50% передплати, для матеріалів, що ріжуться індивідуально, — 100%.</p>
            </li>
            <li>
              <span class="scroll-card__pill">Сервіс</span>
              <p>Можемо запропонувати занесення та збирання меблів, а також оплата частинами до 3 платежів без переплат — залиште запит у менеджера.</p>
            </li>
          </ul>
        </div>
      </article>
    </div>
  </section>
</div>

{% block extra_body %}
<script src="{% static 'js/furniture-detail-alt.js' %}"></script>
{% endblock %}
{% endblock %}
