{% extends 'shop/base.html' %}
{% load cart_filters %}
{% load static %}
{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- Left: Gallery with vertical thumbs -->
    <div class="lg:col-span-7 flex flex-col items-center gap-4 max-w-[720px] w-full mx-auto">
      <div class="w-full bg-white rounded-lg shadow p-4">
        <div class="relative">
          <img id="alt-main-image"
               src="{% if gallery_images and gallery_images.0.image %}{{ gallery_images.0.image.url }}{% endif %}"
               alt="{{ furniture.name }}"
               class="w-full h-[480px] object-cover rounded"
               data-current-index="0"
               data-gallery-size="{% if gallery_images %}{{ gallery_images|length }}{% else %}0{% endif %}">
          {% if gallery_images and gallery_images|length > 1 %}
          <button type="button"
                  class="gallery-nav gallery-nav-prev absolute left-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-9 h-9 flex items-center justify-center shadow"
                  aria-label="Попереднє зображення">
            &#10094;
          </button>
          <button type="button"
                  class="gallery-nav gallery-nav-next absolute right-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-9 h-9 flex items-center justify-center shadow"
                  aria-label="Наступне зображення">
            &#10095;
          </button>
          <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2">
            {% for img in gallery_images %}
            <span class="gallery-dot {% if forloop.first %}bg-brown-800{% else %}bg-white/80{% endif %} w-2.5 h-2.5 rounded-full border border-brown-500/40" data-index="{{ forloop.counter0 }}"></span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      {% if gallery_images %}
      <div class="w-full">
        <div class="relative">
          {% if gallery_images|length > 4 %}
          <button type="button"
                  class="thumb-nav thumb-nav-prev absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-8 h-8 flex items-center justify-center shadow"
                  aria-label="Прокрутити вліво">
            &#10094;
          </button>
          <button type="button"
                  class="thumb-nav thumb-nav-next absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brown-800 rounded-full w-8 h-8 flex items-center justify-center shadow"
                  aria-label="Прокрутити вправо">
            &#10095;
          </button>
          {% endif %}
          <div class="overflow-hidden px-10" data-thumb-scroller>
            <div class="flex gap-3" data-thumb-track>
              {% for img in gallery_images %}
              <img src="{{ img.image.url }}"
                   alt="{{ img.alt_text|default:furniture.name }}"
                   class="w-24 h-24 md:w-28 md:h-28 object-cover rounded border cursor-pointer thumb-item {% if forloop.first %}ring-2 ring-brown-800{% endif %}"
                   data-full="{{ img.image.url }}"
                   data-index="{{ forloop.counter0 }}">
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right: Sticky buy card -->
    <div class="lg:col-span-5">
      <div id="buy-card" class="lg:sticky lg:top-6 bg-white rounded-lg shadow p-6" data-base-size-id="{{ base_size_variant_id|default:'' }}">
        <h1 class="text-2xl font-bold text-brown-800">{{ furniture.name }}</h1>
        <p class="text-sm text-brown-600 mt-1">{{ furniture.sub_category.name }} • Код: {{ furniture.article_code }}</p>
        <div class="mt-3">
          <span id="alt-stock-label"
                class="px-3 py-1 rounded-full text-xs {% if initial_stock_status == 'in_stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}"
                data-base-status="{{ furniture.stock_status }}"
                data-base-text="{{ furniture.get_stock_status_display }}"
                data-default-status="{{ initial_stock_status }}"
                data-default-text="{{ initial_stock_label }}">
            {{ initial_stock_label }}
          </span>
        </div>

        <div class="mt-4 flex items-end gap-3">
          {% if furniture.is_promotional and furniture.promotional_price %}
            <p class="text-3xl text-red-600 font-semibold" id="alt-main-price">{{ furniture.promotional_price|floatformat:0 }} грн</p>
            <p class="text-lg text-brown-500 line-through" id="alt-original-price">{{ furniture.price|floatformat:0 }} грн</p>
          {% else %}
            <p class="text-3xl text-brown-800 font-semibold" id="alt-main-price">{{ furniture.price|floatformat:0 }} грн</p>
            <p class="text-lg text-brown-500 line-through" id="alt-original-price" style="display: none;">{{ furniture.price|floatformat:0 }} грн</p>
          {% endif %}
        </div>

        {% if variant_images %}
        <div class="mt-4">
          <label class="block text-brown-700 font-medium mb-2">Варіанти</label>
          <div class="flex flex-wrap gap-2">
            {% for variant in variant_images %}
            <button type="button" class="variant-chip flex items-center gap-2 px-3 py-2 border rounded text-sm hover:bg-beige-100{% if variant.is_default %} bg-beige-100 ring-2 ring-brown-800{% endif %}" 
                    data-id="{{ variant.id }}" 
                    data-image="{{ variant.image.url }}" 
                    data-name="{{ variant.name }}"
                    data-stock-status="{{ variant.stock_status }}"
                    data-stock-label="{{ variant.get_stock_status_display }}"
                    {% if variant.link %}data-link="{{ variant.link }}"{% endif %}>
              <img src="{{ variant.image.url }}" alt="{{ variant.name }}" class="w-6 h-6 object-cover rounded">
              <span>{{ variant.name }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if size_variants %}
        <div class="mt-4">
          <label for="alt-size" class="block text-brown-700 font-medium mb-2">Розмір (ВхШхД)</label>
          <div class="grid grid-cols-2 gap-2">
            {% if base_dimensions and not base_size_variant_id %}
            <button type="button" class="size-chip px-3 py-2 border rounded text-sm hover:bg-beige-100" 
                    data-id="base" 
                    data-price="{{ furniture.current_price }}" 
                    data-original-price="{{ furniture.price }}"
                    data-dimensions="{{ base_dimensions }}"
                    data-is-on-sale="{{ furniture.is_promotional|yesno:'true,false' }}">
                {{ base_dimensions }}
            </button>
            {% endif %}
            {% for variant in size_variants %}
            <button type="button" class="size-chip px-3 py-2 border rounded text-sm hover:bg-beige-100" 
                    data-id="{{ variant.id }}" 
                    data-price="{{ variant.current_price }}" 
                    data-original-price="{{ variant.price }}"
                    data-dimensions="{{ variant.dimensions }}"
                    data-is-on-sale="{{ variant.is_on_sale|yesno:'true,false' }}"
                    {% if variant.parameter %}
                    data-param-key="{{ variant.parameter.key }}"
                    data-param-value="{{ variant.parameter_value }}"
                    {% endif %}>
                {{ variant.dimensions }}
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if fabric_categories %}
        <div class="mt-4" data-fabric-value="{{ furniture.fabric_value|default:1.0 }}">
          <label class="block text-brown-700 font-medium mb-2" for="alt-fabric">Категорія тканини</label>
          <select id="alt-fabric" class="w-full p-3 border border-brown-300 rounded-lg">
            <option value="">Cтандарт</option>
            {% for category in fabric_categories %}
            <option value="{{ category.id }}" data-price="{{ category.price }}" data-calculated-price="{{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }}">{{ category.name }} — {{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }} грн</option>
            {% endfor %}
          </select>
          <p id="alt-fabric-extra" class="mt-2 text-sm text-brown-700 hidden">Додаткова вартість: <span id="alt-fabric-price" class="font-semibold"></span> грн</p>
        </div>
        {% endif %}

        <div class="mt-4 flex items-center gap-3">
          <label for="alt-qty" class="text-brown-700">Кількість</label>
          <input id="alt-qty" type="number" min="1" value="1" class="w-24 p-2 border border-brown-300 rounded">
        </div>

        <form class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3" method="post" action="{% url 'shop:add_to_cart_from_detail' %}">
          {% csrf_token %}
          <input type="hidden" name="furniture_id" value="{{ furniture.id }}">
          <input type="hidden" name="furniture_slug" value="{{ furniture.slug }}">
          <input type="hidden" name="size_variant_id" id="alt-size-input">
          <input type="hidden" name="fabric_category_id" id="alt-fabric-input">
          <input type="hidden" name="variant_image_id" id="alt-variant-input">
          <input type="hidden" name="quantity" id="alt-qty-input" value="1">
          <button type="submit" class="btn-grad w-full py-3 text-lg font-semibold rounded">Додати в кошик</button>
          <!-- <a href="?v=1" class="w-full py-3 text-lg font-semibold rounded border text-center border-brown-300 text-brown-800 hover:bg-beige-100">Основна версія</a> -->
        </form>
      </div>
    </div>
  </div>

  <!-- Tabs: Description / Specs / Delivery -->
  <div class="mt-8 bg-white rounded-lg shadow">
    <div class="border-b flex">
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent active" data-tab="desc">Опис</button>
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent" data-tab="specs">Характеристики</button>
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent" data-tab="shipping">Доставка та оплата</button>
    </div>
    <div class="p-6">
      <div class="tab-pane" id="tab-desc">{{ furniture.description }}</div>
      <div class="tab-pane hidden" id="tab-specs">
        {% if parameters %}
        <table class="w-full text-left border-separate border-spacing-y-2">
          <tbody>
            {% for param in parameters %}
            <tr class="bg-beige-50 rounded {% if param.key == 'dimensions' %}alt-dim-row{% endif %}">
              <td class="py-2 px-3 text-brown-600 w-1/2">{{ param.label }}</td>
              <td class="py-2 px-3 text-brown-800 font-medium w-1/2" 
                  {% if param.key == 'dimensions' %}id="alt-dimensions"{% else %}id="alt-param-{{ param.key }}"{% endif %}
                  data-param-key="{{ param.key }}"
                  data-base="{{ param.base_value|default:param.value }}">{{ param.value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
      <div class="tab-pane hidden" id="tab-shipping">
        <div class="space-y-2 text-brown-700">
          <p>Безкоштовна доставка безкаркасних меблів по Україні. Інші меблі — за тарифами перевізника.</p>
          <p>Оплата: при отриманні (якщо в наявності), 50% передплата на виготовлення, або повна передплата для матеріалів.</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_body %}
<script src="{% static 'js/furniture-detail-alt.js' %}"></script>
{% endblock %}
{% endblock %}
