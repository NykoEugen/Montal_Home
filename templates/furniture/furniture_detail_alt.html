{% extends 'shop/base.html' %}
{% load cart_filters %}
{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- Left: Gallery with vertical thumbs -->
    <div class="lg:col-span-7 flex gap-4">
      <div class="hidden md:flex flex-col gap-2 w-24">
        {% if gallery_images %}
          {% for img in gallery_images %}
          <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:furniture.name }}" class="w-24 h-24 object-cover rounded border cursor-pointer thumb-item" data-full="{{ img.image.url }}">
          {% endfor %}
        {% endif %}
      </div>
      <div class="flex-1 bg-white rounded-lg shadow p-4">
        <img id="alt-main-image" src="{% if furniture.image %}{{ furniture.image.url }}{% elif gallery_images and gallery_images.0.image %}{{ gallery_images.0.image.url }}{% endif %}" alt="{{ furniture.name }}" class="w-full h-[480px] object-cover rounded">
        <div class="mt-3 md:hidden grid grid-cols-5 gap-2">
          {% if gallery_images %}
            {% for img in gallery_images %}
            <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:furniture.name }}" class="w-full h-16 object-cover rounded border cursor-pointer thumb-item" data-full="{{ img.image.url }}">
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right: Sticky buy card -->
    <div class="lg:col-span-5">
      <div id="buy-card" class="lg:sticky lg:top-6 bg-white rounded-lg shadow p-6" data-base-size-id="{{ base_size_variant_id|default:'' }}">
        <h1 class="text-2xl font-bold text-brown-800">{{ furniture.name }}</h1>
        <p class="text-sm text-brown-600 mt-1">{{ furniture.sub_category.name }} • Код: {{ furniture.article_code }}</p>
        <div class="mt-3">
          <span class="px-3 py-1 rounded-full text-xs {% if furniture.stock_status == 'in_stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
            {% if furniture.stock_status == 'in_stock' %}Є в наявності{% else %}Під замовлення{% endif %}
          </span>
        </div>

        <div class="mt-4 flex items-end gap-3">
          {% if furniture.is_promotional and furniture.promotional_price %}
            <p class="text-3xl text-red-600 font-semibold" id="alt-main-price">{{ furniture.promotional_price|floatformat:0 }} грн</p>
            <p class="text-lg text-brown-500 line-through" id="alt-original-price">{{ furniture.price|floatformat:0 }} грн</p>
          {% else %}
            <p class="text-3xl text-brown-800 font-semibold" id="alt-main-price">{{ furniture.price|floatformat:0 }} грн</p>
          {% endif %}
        </div>

        {% if variant_images %}
        <div class="mt-4">
          <label class="block text-brown-700 font-medium mb-2">Варіанти</label>
          <div class="flex flex-wrap gap-2">
            {% for variant in variant_images %}
            <button type="button" class="variant-chip flex items-center gap-2 px-3 py-2 border rounded text-sm hover:bg-beige-100{% if variant.is_default %} bg-beige-100 ring-2 ring-brown-800{% endif %}" 
                    data-id="{{ variant.id }}" 
                    data-image="{{ variant.image.url }}" 
                    data-name="{{ variant.name }}"
                    {% if variant.link %}data-link="{{ variant.link }}"{% endif %}>
              <img src="{{ variant.image.url }}" alt="{{ variant.name }}" class="w-6 h-6 object-cover rounded">
              <span>{{ variant.name }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if size_variants %}
        <div class="mt-4">
          <label for="alt-size" class="block text-brown-700 font-medium mb-2">Розмір (ВхШхД)</label>
          <div class="grid grid-cols-2 gap-2">
            {% if base_dimensions and not base_size_variant_id %}
            <button type="button" class="size-chip px-3 py-2 border rounded text-sm hover:bg-beige-100" data-id="base" data-price="{{ furniture.current_price }}" data-dimensions="{{ base_dimensions }}">{{ base_dimensions }}</button>
            {% endif %}
            {% for variant in size_variants %}
            <button type="button" class="size-chip px-3 py-2 border rounded text-sm hover:bg-beige-100" data-id="{{ variant.id }}" data-price="{{ variant.price }}" data-dimensions="{{ variant.dimensions }}">{{ variant.dimensions }}</button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if fabric_categories %}
        <div class="mt-4" data-fabric-value="{{ furniture.fabric_value|default:1.0 }}">
          <label class="block text-brown-700 font-medium mb-2" for="alt-fabric">Категорія тканини</label>
          <select id="alt-fabric" class="w-full p-3 border border-brown-300 rounded-lg">
            <option value="">Cтандарт</option>
            {% for category in fabric_categories %}
            <option value="{{ category.id }}" data-price="{{ category.price }}" data-calculated-price="{{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }}">{{ category.name }} — {{ category.price|multiply:furniture.fabric_value|default:1.0|floatformat:0 }} грн</option>
            {% endfor %}
          </select>
          <p id="alt-fabric-extra" class="mt-2 text-sm text-brown-700 hidden">Додаткова вартість: <span id="alt-fabric-price" class="font-semibold"></span> грн</p>
        </div>
        {% endif %}

        <div class="mt-4 flex items-center gap-3">
          <label for="alt-qty" class="text-brown-700">Кількість</label>
          <input id="alt-qty" type="number" min="1" value="1" class="w-24 p-2 border border-brown-300 rounded">
        </div>

        <form class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3" method="post" action="{% url 'shop:add_to_cart_from_detail' %}">
          {% csrf_token %}
          <input type="hidden" name="furniture_id" value="{{ furniture.id }}">
          <input type="hidden" name="furniture_slug" value="{{ furniture.slug }}">
          <input type="hidden" name="size_variant_id" id="alt-size-input">
          <input type="hidden" name="fabric_category_id" id="alt-fabric-input">
          <input type="hidden" name="variant_image_id" id="alt-variant-input">
          <input type="hidden" name="quantity" id="alt-qty-input" value="1">
          <button type="submit" class="btn-grad w-full py-3 text-lg font-semibold rounded">Додати в кошик</button>
          <!-- <a href="?v=1" class="w-full py-3 text-lg font-semibold rounded border text-center border-brown-300 text-brown-800 hover:bg-beige-100">Основна версія</a> -->
        </form>
      </div>
    </div>
  </div>

  <!-- Tabs: Description / Specs / Delivery -->
  <div class="mt-8 bg-white rounded-lg shadow">
    <div class="border-b flex">
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent active" data-tab="desc">Опис</button>
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent" data-tab="specs">Характеристики</button>
      <button class="tab-link px-4 py-3 text-brown-700 font-medium border-b-2 border-transparent" data-tab="shipping">Доставка та оплата</button>
    </div>
    <div class="p-6">
      <div class="tab-pane" id="tab-desc">{{ furniture.description }}</div>
      <div class="tab-pane hidden" id="tab-specs">
        {% if parameters %}
        <table class="w-full text-left border-separate border-spacing-y-2">
          <tbody>
            {% for param in parameters %}
            <tr class="bg-beige-50 rounded {% if param.key == 'dimensions' %}alt-dim-row{% endif %}">
              <td class="py-2 px-3 text-brown-600 w-1/2">{{ param.label }}</td>
              <td class="py-2 px-3 text-brown-800 font-medium w-1/2" {% if param.key == 'dimensions' %}id="alt-dimensions" data-base="{{ param.base_value|default:param.value }}"{% endif %}>{{ param.value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
      <div class="tab-pane hidden" id="tab-shipping">
        <div class="space-y-2 text-brown-700">
          <p>Безкоштовна доставка безкаркасних меблів по Україні. Інші меблі — за тарифами перевізника.</p>
          <p>Оплата: при отриманні (якщо в наявності), 50% передплата на виготовлення, або повна передплата для матеріалів.</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_body %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const mainImg = document.getElementById('alt-main-image');
  document.querySelectorAll('.thumb-item').forEach(t => t.addEventListener('click', () => {
    const url = t.getAttribute('data-full');
    if (url) mainImg.src = url;
  }));

  const priceEl = document.getElementById('alt-main-price');
  const origEl = document.getElementById('alt-original-price');
  const sizeChips = document.querySelectorAll('.size-chip');
  const variantChips = document.querySelectorAll('.variant-chip');
  const sizeInput = document.getElementById('alt-size-input');
  const variantInput = document.getElementById('alt-variant-input');
  const fabricSelect = document.getElementById('alt-fabric');
  const fabricInput = document.getElementById('alt-fabric-input');
  const fabricExtra = document.getElementById('alt-fabric-extra');
  const fabricExtraPrice = document.getElementById('alt-fabric-price');
  const dimCell = document.getElementById('alt-dimensions');
  const qty = document.getElementById('alt-qty');
  const qtyInput = document.getElementById('alt-qty-input');
  const fabricValue = parseFloat((fabricSelect?.parentElement?.getAttribute('data-fabric-value')) || '1');

  let basePrice = 0; let selectedPrice = 0;
  if (priceEl) {
    basePrice = parseFloat(priceEl.textContent.replace(' грн','').trim());
    selectedPrice = basePrice;
  }

  function recompute() {
    let total = selectedPrice;
    if (fabricSelect && fabricSelect.value && fabricExtra && fabricExtraPrice) {
      const calculatedPrice = parseFloat(fabricSelect.options[fabricSelect.selectedIndex].getAttribute('data-calculated-price') || '0');
      if (calculatedPrice > 0) {
        fabricExtra.classList.remove('hidden');
        fabricExtraPrice.textContent = Math.round(calculatedPrice);
        total += calculatedPrice;
      } else {
        fabricExtra.classList.add('hidden');
      }
    } else if (fabricExtra) {
      fabricExtra.classList.add('hidden');
    }
    const q = Math.max(1, parseInt(qty.value || '1', 10));
    if (qtyInput) qtyInput.value = String(q);
    if (priceEl) {
      priceEl.textContent = Math.round(total * q) + ' грн';
    }
  }

  // Variant chip functionality
  variantChips.forEach(b => b.addEventListener('click', () => {
    variantChips.forEach(x => x.classList.remove('bg-beige-100','ring-2','ring-brown-800'));
    b.classList.add('bg-beige-100','ring-2','ring-brown-800');
    const imageUrl = b.getAttribute('data-image');
    const linkUrl = b.getAttribute('data-link');
    const variantId = b.getAttribute('data-id');
    
    if (imageUrl && mainImg) {
      mainImg.src = imageUrl;
    }
    
    if (variantInput) {
      variantInput.value = variantId || '';
    }
    
    // If there's a link, you can handle it here
    if (linkUrl) {
      // You can either open in new tab or handle differently
      // window.open(linkUrl, '_blank');
    }
  }));

  sizeChips.forEach(b => b.addEventListener('click', () => {
    sizeChips.forEach(x => x.classList.remove('bg-beige-100','ring-2','ring-brown-800'));
    b.classList.add('bg-beige-100','ring-2','ring-brown-800');
    const p = parseFloat(b.getAttribute('data-price') || '0');
    selectedPrice = p > 0 ? p : basePrice;
    if (sizeInput) sizeInput.value = b.getAttribute('data-id') || '';
    const d = b.getAttribute('data-dimensions');
    if (dimCell && d) dimCell.textContent = d; else if (dimCell) dimCell.textContent = dimCell.getAttribute('data-base') || '';
    recompute();
  }));

  if (fabricSelect) {
    fabricSelect.addEventListener('change', () => {
      if (fabricInput) fabricInput.value = fabricSelect.value || '';
      recompute();
    });
  }

  if (qty) {
    qty.addEventListener('input', recompute);
  }

  // Auto-select base size if provided
  const buyCard = document.getElementById('buy-card');
  const baseIdAttr = buyCard ? buyCard.getAttribute('data-base-size-id') : '';
  const baseId = baseIdAttr ? parseInt(baseIdAttr, 10) : null;
  if (baseId !== null && !Number.isNaN(baseId)) {
    const baseBtn = Array.from(sizeChips).find(b => (b.getAttribute('data-id') || '') == String(baseId));
    if (baseBtn) {
      baseBtn.click();
    }
  } else if (sizeChips.length) {
    // fallback: select first
    sizeChips[0].click();
  }

  // Auto-select default variant if available
  if (variantChips.length) {
    const defaultVariant = Array.from(variantChips).find(b => b.classList.contains('bg-beige-100'));
    if (defaultVariant) {
      const variantId = defaultVariant.getAttribute('data-id');
      if (variantInput && variantId) {
        variantInput.value = variantId;
      }
    }
  }

  // Tabs
  const tabs = document.querySelectorAll('.tab-link');
  const panes = {
    desc: document.getElementById('tab-desc'),
    specs: document.getElementById('tab-specs'),
    shipping: document.getElementById('tab-shipping')
  };
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active','border-brown-800'));
    Object.values(panes).forEach(p => p.classList.add('hidden'));
    const key = btn.getAttribute('data-tab');
    btn.classList.add('active','border-brown-800');
    if (panes[key]) panes[key].classList.remove('hidden');
  }));
});
</script>
{% endblock %}
{% endblock %}

