{% extends 'shop/base.html' %}
{% csrf_token %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row gap-8 items-start">
        <div class="md:w-1/2 w-full">
            <div class="bg-white rounded-lg shadow-lg p-4 flex flex-col gap-3 items-center justify-center">
                <img id="main-image" src="{% if furniture.image %}{{ furniture.image.url }}{% elif gallery_images and gallery_images.0.image %}{{ gallery_images.0.image.url }}{% endif %}" alt="{{ furniture.name }}" class="w-full h-80 object-cover rounded-lg shadow">
                {% if gallery_images %}
                <div class="flex gap-2 overflow-x-auto w-full">
                    {% for img in gallery_images %}
                        <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:furniture.name }}" class="w-20 h-20 object-cover rounded border cursor-pointer hover:opacity-80" data-full="{{ img.image.url }}">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        <div class="md:w-1/2 w-full md:pl-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-3xl font-bold text-brown-800 mb-2">{{ furniture.name }}</h1>
                <p class="text-brown-600 mb-2">{{ furniture.category.name }}</p>
                <div class="mb-4 flex flex-wrap gap-4 text-sm">
                    <span class="bg-beige-100 px-3 py-1 rounded-full text-brown-700">
                        <strong>Код товару:</strong> {{ furniture.article_code }}
                    </span>
                    <span class="px-3 py-1 rounded-full {% if furniture.stock_status == 'in_stock' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-700{% endif %}">
                        <strong>Наявність:</strong> 
                        {% if furniture.stock_status == 'in_stock' %}
                            На складі
                        {% else %}
                            Під замовлення
                        {% endif %}
                    </span>
                </div>
                {% if size_variants %}
                    <div class="mb-6">
                        <label for="size-variant" class="block text-brown-700 font-medium mb-2">
                            Оберіть розмір:
                        </label>
                        <select id="size-variant" class="w-full p-3 border border-brown-300 rounded-lg focus:ring-2 focus:ring-brown-400 focus:border-brown-400 bg-white">
                            <option value="">Оберіть розмір</option>
                            {% for variant in size_variants %}
                                <option value="{{ variant.id }}" 
                                        data-price="{{ variant.price }}"
                                        data-dimensions="{{ variant.dimensions }}">
                                    {{ variant.dimensions }} - {{ variant.price|floatformat:0 }} грн
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                
                <div class="mb-4">
                    {% if furniture.is_promotional and furniture.promotional_price %}
                        <p class="text-2xl text-red-600 font-semibold" id="main-price">{{ furniture.promotional_price|floatformat:0 }} грн</p>
                        <p class="text-lg text-brown-500 line-through" id="original-price">{{ furniture.price|floatformat:0 }} грн</p>
                    {% else %}
                        <p class="text-2xl text-brown-800 font-semibold" id="main-price">{{ furniture.price|floatformat:0 }} грн</p>
                    {% endif %}
                </div>
                
                {% if fabric_categories %}
                    <div class="mb-6">
                        <!-- <h3 class="text-lg font-semibold text-brown-800 mb-3">Вибір тканини</h3> -->
                        <div class="bg-beige-50 rounded-lg p-4" data-fabric-value="{{ furniture.fabric_value|default:1.0 }}">
                            <label for="fabric-category" class="block text-brown-700 font-medium mb-2">
                                Оберіть категорію тканини:
                            </label>
                            <select id="fabric-category" class="w-full p-3 border border-brown-300 rounded-lg focus:ring-2 focus:ring-brown-400 focus:border-brown-400 bg-white">
                                <option value="">Категорія тканини</option>
                                {% for category in fabric_categories %}
                                    <option value="{{ category.id }}" data-price="{{ category.price }}">
                                        {{ category.name }} - {{ category.price|floatformat:0 }} грн
                                    </option>
                                {% endfor %}
                            </select>
                            <div id="fabric-price-info" class="mt-3 text-brown-600 hidden">
                                <p class="text-sm">Додаткова вартість тканини: <span id="fabric-price" class="font-semibold"></span> грн</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="mb-6">
                    <p class="text-brown-600 mb-3">{{ furniture.description }}</p>
                </div>
                {% if parameters %}
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-brown-800 mb-2">Характеристики</h2>
                        <table class="w-full text-left border-separate border-spacing-y-2">
                            <tbody>
                                {% for param in parameters %}
                                    <tr class="bg-beige-50 rounded" {% if param.key == 'dimensions' %}id="dimensions-row"{% endif %}>
                                        <td class="py-2 px-3 text-brown-600 w-1/2">{{ param.label }}</td>
                                        <td class="py-2 px-3 text-brown-800 font-medium w-1/2" {% if param.key == 'dimensions' %}id="dimensions-value" data-base="{{ param.base_value|default:param.value }}"{% endif %}>
                                            {{ param.value }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}

                            </div>
                
                <div class="mt-6">
                    <form id="add-to-cart-form" method="post" action="{% url 'shop:add_to_cart_from_detail' %}">
                        {% csrf_token %}
                        <input type="hidden" name="furniture_id" value="{{ furniture.id }}">
                        <input type="hidden" name="furniture_slug" value="{{ furniture.slug }}">
                        <input type="hidden" name="size_variant_id" id="selected-size-variant">
                        <input type="hidden" name="fabric_category_id" id="selected-fabric-category">
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn-grad w-full py-3 text-lg font-semibold rounded-lg shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-brown-400 transition">
                            <i class="fa fa-cart-plus mr-2"></i> Додати до кошика
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sizeSelect = document.getElementById('size-variant');
    const fabricSelect = document.getElementById('fabric-category');
    const fabricPriceInfo = document.getElementById('fabric-price-info');
    const fabricPriceSpan = document.getElementById('fabric-price');
    const mainPriceElement = document.getElementById('main-price');
    const originalPriceElement = document.getElementById('original-price');
    // Get the base furniture price
    let basePrice = 0;
    let originalPrice = 0;
    let selectedSizePrice = 0;
    
    if (mainPriceElement) {
        basePrice = parseFloat(mainPriceElement.textContent.replace(' грн', '').trim());
        originalPrice = basePrice;
        selectedSizePrice = basePrice;
    }
    
    // Get fabric_value from the data attribute
    const fabricValueElement = document.querySelector('[data-fabric-value]');
    const fabricValue = fabricValueElement ? parseFloat(fabricValueElement.getAttribute('data-fabric-value')) : 1.0;
    
    // Function to update total price
    function updateTotalPrice() {
        let totalPrice = selectedSizePrice;
        
        // Add fabric cost if fabric is selected
        if (fabricSelect && fabricSelect.value) {
            const selectedFabricOption = fabricSelect.options[fabricSelect.selectedIndex];
            const fabricPrice = parseFloat(selectedFabricOption.getAttribute('data-price') || 0);
            if (fabricPrice > 0) {
                const fabricCost = fabricPrice * fabricValue;
                totalPrice += fabricCost;
                fabricPriceSpan.textContent = Math.round(fabricCost);
                fabricPriceInfo.classList.remove('hidden');
            } else {
                fabricPriceInfo.classList.add('hidden');
            }
        } else {
            fabricPriceInfo.classList.add('hidden');
        }
        
        // Update the displayed price
        if (mainPriceElement) {
            mainPriceElement.textContent = Math.round(totalPrice) + ' грн';
        }
    }
    
    // Handle size variant selection
    if (sizeSelect) {
        sizeSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const sizePrice = parseFloat(selectedOption.getAttribute('data-price') || 0);
            const sizeDimensions = selectedOption.getAttribute('data-dimensions');
            
            if (sizePrice > 0) {
                selectedSizePrice = sizePrice;
            } else {
                selectedSizePrice = originalPrice;
            }
            
            // Update dimensions in characteristics table
            const dimensionsValue = document.getElementById('dimensions-value');
            
            if (dimensionsValue) {
                if (sizeDimensions) {
                    // Parse the dimensions string (e.g., "120x60x80 см") and format as "висота*ширина*довжина"
                    const dimensionsMatch = sizeDimensions.match(/(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)/);
                    if (dimensionsMatch) {
                        const height = dimensionsMatch[1];
                        const width = dimensionsMatch[2];
                        const length = dimensionsMatch[3];
                        dimensionsValue.textContent = `${height}x${width}x${length} см`;
                    } else {
                        dimensionsValue.textContent = sizeDimensions; // keep as-is
                    }
                } else {
                    // If no size selected, revert to base size (from server-rendered value)
                    dimensionsValue.textContent = dimensionsValue.getAttribute('data-base');
                }
            }
            
            updateTotalPrice();
        });
    }
    
    // Handle fabric selection
    if (fabricSelect) {
        fabricSelect.addEventListener('change', function() {
            updateTotalPrice();
        });
    }
    
    // Handle form submission
    const addToCartForm = document.getElementById('add-to-cart-form');
    const selectedSizeVariantInput = document.getElementById('selected-size-variant');
    const selectedFabricCategoryInput = document.getElementById('selected-fabric-category');
    
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Update hidden fields with current selections
            if (sizeSelect && sizeSelect.value) {
                selectedSizeVariantInput.value = sizeSelect.value;
            }
            
            if (fabricSelect && fabricSelect.value) {
                selectedFabricCategoryInput.value = fabricSelect.value;
            }
            
            // Submit the form
            this.submit();
        });
    }

    // Thumbnail click to swap main image
    const mainImg = document.getElementById('main-image');
    document.querySelectorAll('[data-full]').forEach(function(thumb){
        thumb.addEventListener('click', function(){
            const url = this.getAttribute('data-full');
            if (mainImg && url) {
                mainImg.src = url;
            }
        });
    });
});
</script>
{% endblock %}