{% extends 'shop/base.html' %}
{% load static %}
{% load cart_filters %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-brown-500 to-brown-600 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-brown-800">{{ sub_category.name }}</h1>
            </div>
            <div class="hidden md:flex items-center gap-2 text-sm text-brown-600">
                <span>{{ page_obj.paginator.count }} —Ç–æ–≤–∞—Ä—ñ–≤</span>
                <div class="w-2 h-2 bg-brown-500 rounded-full"></div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:w-1/4">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-4">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-brown-800">–§—ñ–ª—å—Ç—Ä–∏</h2>
                        <button id="clearAllFilters" class="text-sm text-red-500 hover:text-red-700 transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ
                        </button>
                    </div>

                    <form method="get" id="filterForm">
                        <!-- Price Range Filter -->
                        <div class="filter-section mb-6">
                            <div class="filter-header" onclick="toggleFilterSection(this)">
                                <h3 class="text-lg font-semibold text-brown-700">–î—ñ–∞–ø–∞–∑–æ–Ω —Ü—ñ–Ω</h3>
                                <svg class="w-5 h-5 text-brown-500 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="filter-content">
                                <div class="space-y-3">
                                    <div class="flex gap-2">
                                        <input type="number" name="min_price" placeholder="–í—ñ–¥" 
                                               value="{{ request.GET.min_price|default:'' }}"
                                               class="w-full px-3 py-2 border border-beige-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                                        <input type="number" name="max_price" placeholder="–î–æ" 
                                               value="{{ request.GET.max_price|default:'' }}"
                                               class="w-full px-3 py-2 border border-beige-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                                    </div>
                                    <div class="text-xs text-brown-600">
                                        –¶—ñ–Ω–∏ –≤ –≥—Ä–∏–≤–Ω—è—Ö
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Status Filter -->
                        <div class="filter-section mb-6">
                            <div class="filter-header" onclick="toggleFilterSection(this)">
                                <h3 class="text-lg font-semibold text-brown-700">–ù–∞—è–≤–Ω—ñ—Å—Ç—å</h3>
                                <svg class="w-5 h-5 text-brown-500 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="filter-content">
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="stock_status" value="in_stock" 
                                               {% if 'in_stock' in request.GET|getlist:'stock_status' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 rounded focus:ring-brown-500">
                                        <span class="text-brown-700">–ù–∞ —Å–∫–ª–∞–¥—ñ</span>
                                        <span class="ml-auto text-xs text-brown-500 bg-green-100 px-2 py-1 rounded-full">‚úì</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="stock_status" value="on_order" 
                                               {% if 'on_order' in request.GET|getlist:'stock_status' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 rounded focus:ring-brown-500">
                                        <span class="text-brown-700">–ü—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>
                                        <span class="ml-auto text-xs text-brown-500 bg-orange-100 px-2 py-1 rounded-full">‚è≥</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Promotional Items Filter -->
                        <div class="filter-section mb-6">
                            <div class="filter-header" onclick="toggleFilterSection(this)">
                                <h3 class="text-lg font-semibold text-brown-700">–ê–∫—Ü—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏</h3>
                                <svg class="w-5 h-5 text-brown-500 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="filter-content">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="promotional_only" value="true" 
                                           {% if request.GET.promotional_only %}checked{% endif %}
                                           class="w-4 h-4 text-red-600 border-beige-300 rounded focus:ring-red-500">
                                    <span class="text-brown-700">–¢—ñ–ª—å–∫–∏ –∞–∫—Ü—ñ–π–Ω—ñ</span>
                                    <span class="ml-auto text-xs text-red-500 bg-red-100 px-2 py-1 rounded-full">üî•</span>
                                </label>
                            </div>
                        </div>

                        <!-- Sorting -->
                        <div class="filter-section mb-6">
                            <div class="filter-header" onclick="toggleFilterSection(this)">
                                <h3 class="text-lg font-semibold text-brown-700">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</h3>
                                <svg class="w-5 h-5 text-brown-500 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="filter-content">
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="sort" value="" 
                                               {% if not current_sort %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="sort" value="price_asc" 
                                               {% if current_sort == 'price_asc' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–í—ñ–¥ –¥–µ—à–µ–≤–æ–≥–æ –¥–æ –¥–æ—Ä–æ–≥–æ–≥–æ</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="sort" value="price_desc" 
                                               {% if current_sort == 'price_desc' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–í—ñ–¥ –¥–æ—Ä–æ–≥–æ–≥–æ –¥–æ –¥–µ—à–µ–≤–æ–≥–æ</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="sort" value="name_asc" 
                                               {% if current_sort == 'name_asc' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–ó–∞ –Ω–∞–∑–≤–æ—é –ê-–Ø</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="sort" value="name_desc" 
                                               {% if current_sort == 'name_desc' %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–ó–∞ –Ω–∞–∑–≤–æ—é –Ø-–ê</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Parameter Filters -->
                        {% for key, param in filter_options.items %}
                        <div class="filter-section mb-6">
                            <div class="filter-header" onclick="toggleFilterSection(this)">
                                <h3 class="text-lg font-semibold text-brown-700">{{ param.label }}</h3>
                                <svg class="w-5 h-5 text-brown-500 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="filter-content">
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="param_{{ key }}" value="" 
                                               {% if not request.GET|get_item:'param_'|add:key %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">–£—Å—ñ</span>
                                    </label>
                                    {% for value in param.values %}
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="param_{{ key }}" value="{{ value }}"
                                               {% if request.GET|get_item:'param_'|add:key == value %}checked{% endif %}
                                               class="w-4 h-4 text-brown-600 border-beige-300 focus:ring-brown-500">
                                        <span class="text-brown-700">{{ value }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Filter Actions -->
                        <div class="space-y-3 pt-4 border-t border-beige-200">
                            <button type="submit" class="w-full bg-gradient-to-r from-brown-500 to-brown-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-brown-600 hover:to-brown-700 transition-all duration-300 transform hover:scale-105">
                                –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                            </button>
                            <a href="{% url 'sub_categories:sub_categories_details' sub_category.slug %}" 
                               class="block w-full bg-beige-200 text-brown-700 py-3 px-4 rounded-lg text-center font-semibold hover:bg-beige-300 transition-all duration-300">
                                –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="lg:w-3/4">
                <!-- Active Filters Display -->
                {% if current_filters or request.GET.min_price or request.GET.max_price or request.GET|has_stock_status or request.GET.promotional_only %}
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-brown-700">–ê–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏:</h3>
                        <button onclick="clearAllFilters()" class="text-sm text-red-500 hover:text-red-700 transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        {% if request.GET.min_price or request.GET.max_price %}
                        <span class="bg-brown-100 text-brown-700 px-3 py-1 rounded-full text-sm">
                            –¶—ñ–Ω–∞: {{ request.GET.min_price|default:'0' }} - {{ request.GET.max_price|default:'‚àû' }} –≥—Ä–Ω
                        </span>
                        {% endif %}
                        {% for status in request.GET|getlist:'stock_status' %}
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">
                            {% if status == 'in_stock' %}–ù–∞ —Å–∫–ª–∞–¥—ñ{% else %}–ü—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endif %}
                        </span>
                        {% endfor %}
                        {% if request.GET.promotional_only %}
                        <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">
                            –¢—ñ–ª—å–∫–∏ –∞–∫—Ü—ñ–π–Ω—ñ
                        </span>
                        {% endif %}
                        {% for filter_key, filter_value in current_filters %}
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                            {{ filter_key|replace:'param_:'|title }}: {{ filter_value }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Products Grid -->
                {% if page_obj %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for item in page_obj %}
                            <div class="furniture-card bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group relative">
                                <!-- Image Container -->
                                <div class="relative overflow-hidden">
                                    <!-- Promotional Badge -->
                                    {% if item.is_promotional and item.promotional_price %}
                                    <div class="promotional-badge">
                                        -{{ item.discount_percentage|floatformat:0 }}%
                                    </div>
                                    {% endif %}
                                    {% if item.image %}
                                        <img src="{{ item.image.url }}" alt="{{ item.name }}" 
                                             class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-700">
                                    {% else %}
                                        <div class="w-full h-64 bg-gradient-to-br from-beige-200 to-beige-300 flex items-center justify-center">
                                            <svg class="w-20 h-20 text-beige-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Removed text overlay for cleaner look -->
                                </div>
                                
                                <!-- Enhanced Content -->
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <h2 class="text-xl font-bold text-brown-800 group-hover:text-brown-600 transition-colors duration-300 line-clamp-2 leading-tight">{{ item.name }}</h2>
                                        <span class="px-3 py-1.5 text-xs rounded-full font-semibold {% if item.stock_status == 'in_stock' %}bg-green-100 text-green-700 border border-green-200{% else %}bg-orange-100 text-orange-700 border border-orange-200{% endif %}">
                                            {% if item.stock_status == 'in_stock' %}
                                                ‚úì –ù–∞ —Å–∫–ª–∞–¥—ñ
                                            {% else %}
                                                ‚è≥ –ü—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <!-- Enhanced Description -->
                                    <p class="text-brown-600 text-sm mb-5 line-clamp-3 leading-relaxed">{{ item.description|truncatewords:20 }}</p>
                                    
                                    <!-- Enhanced Price Section -->
                                    <div class="space-y-3 mb-6">
                                        {% if item.is_promotional and item.promotional_price %}
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl font-bold text-red-600">{{ item.promotional_price|floatformat:0 }} –≥—Ä–Ω</span>
                                                <span class="text-lg text-gray-400 line-through">{{ item.price|floatformat:0 }} –≥—Ä–Ω</span>
                                            </div>
                                            <div class="text-sm text-green-600 font-semibold bg-green-50 px-3 py-2 rounded-lg">
                                                üí∞ –ï–∫–æ–Ω–æ–º—ñ—è: {{ item.price|calculate_savings:item.promotional_price|floatformat:0 }} –≥—Ä–Ω
                                            </div>
                                        {% else %}
                                            <div class="text-2xl font-bold text-brown-800">{{ item.price|floatformat:0 }} –≥—Ä–Ω</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Enhanced Action Button -->
                                    <div class="mt-6">
                                        <a href="{% url 'furniture:furniture_detail' item.slug %}" 
                                           class="block bg-gradient-to-r from-brown-500 to-brown-600 text-white py-4 px-6 rounded-xl text-center font-semibold group-hover:from-brown-600 group-hover:to-brown-700 transition-all duration-300 transform group-hover:scale-105 shadow-lg">
                                            üìã –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                        <div class="mt-12 flex justify-center">
                            <nav class="flex items-center space-x-2">
                                {% if page_obj.has_previous %}
                                    <a href="{% build_url_with_params page_obj.previous_page_number %}"
                                       class="px-4 py-2 bg-beige-200 text-brown-800 rounded-lg hover:bg-beige-300 transition-colors duration-200">
                                        ‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—è
                                    </a>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <span class="px-4 py-2 bg-brown-500 text-white rounded-lg font-semibold">{{ num }}</span>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <a href="{% build_url_with_params num %}"
                                           class="px-4 py-2 bg-beige-200 text-brown-800 rounded-lg hover:bg-beige-300 transition-colors duration-200">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                    <a href="{% build_url_with_params page_obj.next_page_number %}"
                                       class="px-4 py-2 bg-beige-200 text-brown-800 rounded-lg hover:bg-beige-300 transition-colors duration-200">
                                        –ù–∞—Å—Ç—É–ø–Ω–∞ ‚Üí
                                    </a>
                                {% endif %}
                            </nav>
                        </div>
                    {% endif %}
                {% else %}
                    <!-- Empty State -->
                    <div class="text-center py-16">
                        <div class="w-24 h-24 bg-beige-200 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-beige-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-brown-800 mb-2">–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p class="text-brown-600 mb-6">–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –∞–±–æ –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è —ñ–Ω—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</p>
                        <a href="{% url 'sub_categories:sub_categories_details' sub_category.slug %}" 
                           class="bg-gradient-to-r from-brown-500 to-brown-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-brown-600 hover:to-brown-700 transition-all duration-300">
                            –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}