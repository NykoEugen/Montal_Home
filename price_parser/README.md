# Price Parser App

Цей додаток дозволяє автоматично оновлювати ціни меблів з Google таблиць та XLSX файлів.

## Функціональність

- **Конфігурація Google таблиць та XLSX файлів**: Налаштування параметрів парсингу для різних джерел
- **Автоматичне оновлення цін**: Парсинг та оновлення цін меблів з таблиць та файлів
- **Прямий мапінг комірок**: Точне вказання координат комірок з цінами
- **Логування**: Детальні логи всіх операцій оновлення
- **Тестування**: Можливість тестувати парсинг без оновлення цін

## Встановлення

1. Додайте додаток до `INSTALLED_APPS` в `settings.py`:
```python
INSTALLED_APPS = [
    # ...
    "price_parser.apps.PriceParserConfig",
]
```

2. Виконайте міграції:
```bash
python manage.py makemigrations price_parser
python manage.py migrate
```

## Використання

### 1. Створення конфігурації з URL

Найпростіший спосіб створити нову конфігурацію - використовувати командний рядок:

```bash
# Витягнути GID з URL
python3 manage.py extract_gid_from_url --url "YOUR_GOOGLE_SHEETS_URL"

# Створити конфігурацію з URL
python3 manage.py create_config_from_url \
    --url "YOUR_GOOGLE_SHEETS_URL" \
    --name "My Price Sheet" \
    --sheet-name "Sheet1" \
    --active
```

### 2. Конфігурація через адмін панель

Також можна створювати конфігурації через Django адмін панель:

1. Перейдіть в Admin → Price Parser → Google Sheet Configurations
2. Натисніть "Add Google Sheet Configuration"
3. Заповніть поля:

**Для Google таблиць:**
   - **Name**: Описова назва конфігурації
   - **Sheet URL**: Повний URL Google таблиці (включаючи #gid= якщо потрібно)
   - **Sheet ID**: Автоматично витягується з URL
   - **Sheet Name**: Назва сторінки/вкладки
   - **Sheet GID**: GID з URL (опціонально, за замовчуванням 0)

**Для XLSX файлів:**
   - **Name**: Описова назва конфігурації
   - **XLSX File**: Завантажте XLSX файл
   - **Sheet Name**: Назва вкладки в Excel (опціонально, за замовчуванням перша вкладка)

**Загальні налаштування:**
   - **Is Active**: Чи використовувати цю конфігурацію

### 3. Налаштування прямих зв'язків комірок

1. Перейдіть в адмін панель: `/admin/price_parser/furniturepricecellmapping/`
2. Створіть зв'язки між меблями та конкретними комірками в таблиці:
   - **Furniture**: Меблі з бази даних
   - **Size Variant**: Варіант розміру (опціонально)
   - **Sheet Row**: Номер рядка в таблиці
   - **Sheet Column**: Колонка в таблиці (A, B, C, тощо)
   - **Is Active**: Чи активний зв'язок

### 4. Оновлення цін

#### Через адмін панель:
1. Перейдіть до конфігурації в адмін панелі
2. Натисніть кнопку "Оновити ціни" або "Тестувати парсинг"

#### Через командний рядок:
```bash
# Оновити всі активні конфігурації
python manage.py update_prices --all

# Оновити конкретну конфігурацію
python manage.py update_prices --config-id 1

# Тестувати парсинг без оновлення
python manage.py update_prices --config-id 1 --test
```

#### Через веб-інтерфейс:
1. Перейдіть на `/price-parser/`
2. Виберіть конфігурацію
3. Натисніть "Оновити ціни" або "Тестувати парсинг"

### 5. Підтримка кількох джерел

Можна створювати кілька конфігурацій для різних джерел:

```bash
# Конфігурація 1: Google таблиця з оптовими цінами
python3 manage.py create_config_from_url \
    --url "https://docs.google.com/spreadsheets/d/SHEET_ID/edit#gid=GID1" \
    --name "Оптові ціни" \
    --sheet-name "Опт" \
    --active

# Конфігурація 2: XLSX файл з роздрібними цінами
# (створюється через адмін панель або вручну)

# Конфігурація 3: Google таблиця з іншими цінами
python3 manage.py create_config_from_url \
    --url "https://docs.google.com/spreadsheets/d/SHEET_ID/edit#gid=GID2" \
    --name "Роздрібні ціни" \
    --sheet-name "Роздріб" \
    --active
```

### 6. Створення мапінгів для XLSX файлів

```bash
# Створити мапінг для XLSX файлу
python3 manage.py create_xlsx_mapping \
    --config-id 3 \
    --furniture-id 1 \
    --row 5 \
    --column E \
    --price-type "Ціна опт"
```

## Структура даних

### GoogleSheetConfig
- `name`: Назва конфігурації
- `sheet_url`: URL Google таблиці
- `sheet_id`: ID таблиці (автоматично витягується з URL)
- `sheet_name`: Назва сторінки/вкладки в таблиці
- `sheet_gid`: GID сторінки (опціонально, за замовчуванням 0)
- `is_active`: Чи активна конфігурація

### PriceUpdateLog
- `config`: Конфігурація
- `status`: Статус оновлення (success/error/partial)
- `started_at`: Час початку
- `completed_at`: Час завершення
- `items_processed`: Кількість оброблених товарів
- `items_updated`: Кількість оновлених товарів
- `errors`: Список помилок
- `log_details`: Деталі логу

### FurniturePriceCellMapping
- `furniture`: Меблі в базі даних
- `size_variant`: Варіант розміру (опціонально)
- `sheet_row`: Номер рядка в таблиці
- `sheet_column`: Колонка в таблиці (A, B, C, тощо)
- `price_type`: Тип ціни (наприклад: "Стільниця стандарт", "HPL покриття")
- `is_active`: Чи активний зв'язок

## Формат даних в таблиці

Система використовує прямий мапінг комірок, тому структура таблиці може бути будь-якою. Важливо правильно вказати координати комірок з цінами:

### Приклад структури:
```
| A (Модель) | B (Розмір) | C | D | E (Ціна 1) | F (Ціна 2) | G (Ціна 3) |
|------------|------------|---|----|------------|------------|------------|
| Maxi -1    | 1100-1700  |   |    | 10490      | 11120      | 11450      |
| Boston     | 900        |   |    | 6620       | 6990       | 7180       |
```

### Підтримувані формати цін:
- Цілі числа: `10490`
- Десяткові з комою: `10490,50`
- Десяткові з крапкою: `10490.50`

## Логування

Всі операції оновлення логуються в `PriceUpdateLog`. Логи містять:
- Статус операції
- Кількість оброблених та оновлених товарів
- Список помилок з деталями
- Час виконання

## Безпека

- Всі операції вимагають авторизації
- Парсинг виконується в транзакціях для забезпечення цілісності даних
- Детальне логування всіх операцій
- Можливість тестування без оновлення даних

## Розширення

Для додавання нових форматів таблиць:
1. Розширте метод `_parse_size()` в `GoogleSheetsPriceUpdater`
2. Розширте метод `_parse_price()` для нових форматів цін
3. Додайте нові поля в `GoogleSheetConfig` якщо потрібно 